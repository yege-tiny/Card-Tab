# Card-Tab 更新日志

# Cron 触发器 - 自动定时检测

## ✅ 是的，定时触发可以自动刷新状态！

定时触发（Cron Triggers）会自动定期检查所有用户的链接状态，无需手动点击刷新按钮。

## 🎯 工作原理

### 触发流程

```
Cloudflare 定时触发
    ↓
调用 scheduled() 函数
    ↓
获取所有用户数据
    ↓
对每个用户：
  ├─ 使用智能缓存检测链接
  ├─ 跳过1小时内正常的链接
  ├─ 只检测新链接和异常链接
  └─ 更新状态并保存
    ↓
完成，等待下次触发
```

### 智能检测策略

```javascript
// 定时任务使用智能缓存模式
await smartCheckLinks(allLinks, {
    cacheValidDuration: 3600000,  // 1小时缓存
    forceCheck: false,             // 使用缓存
    concurrency: 5,                // 并发数
    timeout: 8000,                 // 超时8秒
    maxRetries: 1,                 // 重试1次
    batchDelay: 1000               // 批次延迟1秒
});
```

**优势**:
- ✅ 自动跳过正常的链接（缓存）
- ✅ 只检测需要更新的链接
- ✅ 避免超过子请求限制
- ✅ 适合大量链接（>100个）

## ⚙️ 配置说明

### 当前配置（wrangler.toml）

```toml
[triggers]
crons = ["0 * * * *"]  # 每小时整点触发
```

### Cron 表达式格式

```
分钟 小时 日 月 星期
*    *   *  *  *
```

### 常用配置示例

**每小时一次（当前）**:
```toml
crons = ["0 * * * *"]
# 每小时的第0分钟触发
# 例如: 00:00, 01:00, 02:00, ...
```

**每30分钟一次**:
```toml
crons = ["0,30 * * * *"]
# 每小时的第0和30分钟触发
# 例如: 00:00, 00:30, 01:00, 01:30, ...
```

**每6小时一次（推荐）**:
```toml
crons = ["0 */6 * * *"]
# 每6小时的第0分钟触发
# 例如: 00:00, 06:00, 12:00, 18:00
```

**每天凌晨2点**:
```toml
crons = ["0 2 * * *"]
# 每天凌晨2点触发
```

**工作日每小时**:
```toml
crons = ["0 * * * 1-5"]
# 周一到周五，每小时触发
```

**多个时间点**:
```toml
crons = [
    "0 */6 * * *",   # 每6小时
    "0 2 * * *"      # 每天凌晨2点
]
```

## 📊 检测统计

### 日志输出

定时任务会输出详细的日志：

```
定时任务触发: 2024-11-29T18:00:00.000Z
检查用户 testUser 的 112 个链接
用户 testUser 检查完成: 总计 112, 正常 100, 异常 12, 缓存 40
定时检查完成: 1 个用户, 112 个链接
```

### 查看日志

**方法 1: Cloudflare Dashboard**
1. 登录 Cloudflare Dashboard
2. 进入 Workers & Pages
3. 选择你的 Worker
4. 点击 "Logs" 标签
5. 查看实时日志

**方法 2: Wrangler CLI**
```bash
wrangler tail
```

## 🚀 部署配置

### 1. 编辑 wrangler.toml

```toml
name = "card-tab"
main = "workers.js"
compatibility_date = "2024-11-29"

[[kv_namespaces]]
binding = "CARD_ORDER"
id = "你的KV命名空间ID"  # ⚠️ 必须替换

[triggers]
crons = ["0 */6 * * *"]  # 修改为你想要的频率
```

### 2. 部署到 Cloudflare

```bash
wrangler deploy
```

### 3. 验证配置

部署后，在 Cloudflare Dashboard 中查看：
- Workers & Pages → 你的 Worker → Triggers
- 应该能看到配置的 Cron 触发器

## 📈 性能和限制

### 免费版限制

**Cron Triggers**:
- ✅ 免费版可用
- ✅ 无次数限制
- ✅ 最小间隔: 1 分钟

**子请求限制**:
- 每次触发最多 50 个子请求
- 使用智能缓存可以检测更多链接

### 对于 112 个链接

**每小时触发一次**:
```
第1小时: 检测前45个（新检测）
第2小时: 检测后67个（前45个缓存）
第3小时: 检测异常的（大部分缓存）
...
```

**结果**: 
- 所有链接都会被定期检测
- 正常链接每小时检测一次（缓存）
- 异常链接每次都重新检测

## 💡 最佳实践

### 推荐配置

**小型网站（<50个链接）**:
```toml
crons = ["0 * * * *"]  # 每小时
```

**中型网站（50-200个链接）**:
```toml
crons = ["0 */6 * * *"]  # 每6小时
```

**大型网站（>200个链接）**:
```toml
crons = ["0 */12 * * *"]  # 每12小时
```

### 优化建议

1. **避免高峰期**
   ```toml
   crons = ["0 2 * * *"]  # 凌晨2点，流量低谷
   ```

2. **分散检测时间**
   ```toml
   crons = ["15 */6 * * *"]  # 每6小时的第15分钟
   ```

3. **工作时间检测**
   ```toml
   crons = ["0 9-18 * * 1-5"]  # 工作日9点到18点
   ```

## 🔍 测试定时任务

### 手动触发测试

虽然 Cron 是自动触发的，但你可以通过以下方式测试：

**方法 1: 修改为高频触发**
```toml
crons = ["* * * * *"]  # 每分钟（仅用于测试）
```
部署后等待1分钟，查看日志。

**方法 2: 使用 Wrangler 测试**
```bash
# 本地测试（需要配置）
wrangler dev

# 查看日志
wrangler tail
```

**测试完成后记得改回正常频率！**

## 📝 常见问题

### Q: 定时任务会消耗我的 Workers 配额吗？
A: 会的，但免费版每天有 100,000 次请求，定时任务消耗很少。

### Q: 定时任务失败了怎么办？
A: 查看日志找出原因。常见问题：
- KV 命名空间 ID 错误
- 子请求超限（使用智能缓存解决）
- 超时（减少并发数）

### Q: 可以设置多个定时任务吗？
A: 可以，在 `crons` 数组中添加多个表达式。

### Q: 定时任务和手动刷新冲突吗？
A: 不冲突。它们都会更新链接状态，互不影响。

### Q: 如何暂停定时任务？
A: 从 `wrangler.toml` 中删除或注释 `[triggers]` 部分，然后重新部署。

### Q: 定时任务会检测所有用户的链接吗？
A: 是的，会遍历所有用户并检测他们的链接。

## 🎯 实际效果

### 你的情况（112个链接）

**配置**: 每6小时触发一次

**第1次触发（00:00）**:
```
检测: 前45个链接
缓存: 0个
耗时: 约15秒
```

**第2次触发（06:00）**:
```
检测: 后67个链接 + 5个异常的
缓存: 40个正常的
耗时: 约20秒
```

**第3次触发（12:00）**:
```
检测: 5个异常的
缓存: 107个正常的
耗时: 约5秒
```

**结果**: 
- ✅ 所有链接都被定期检测
- ✅ 自动更新状态
- ✅ 无需手动操作
- ✅ 刷新页面即可看到最新状态

## 🚀 总结

**定时触发的优势**:
- ✅ 全自动，无需手动操作
- ✅ 使用智能缓存，避免限制
- ✅ 可以检测所有链接（包括>45个）
- ✅ 定期更新，保持状态最新
- ✅ 免费版可用

**推荐配置**:
```toml
[triggers]
crons = ["0 */6 * * *"]  # 每6小时检测一次
```

**部署命令**:
```bash
wrangler deploy
```

部署后，你的链接状态会自动定期更新，无需任何手动操作！🎉

## [2025.06.01] - 功能全面增强
### 新增功能
1. 增加卡片描述功能，鼠标悬停显示详细信息
2. 增加卡片编辑功能，支持修改名称、网址、描述和图标
3. 增加分类编辑和移动功能，支持分类重命名和移动顺序
4. 增加自定义图标功能，支持图片URL链接（PNG、JPG、SVG等格式）
5. 增加返回顶部按钮功能
6. 重新适配移动端布局和交互体验
7. 优化书签搜索方式和图标样式设计

🙏 **特别感谢** [@lineagett](https://github.com/lineagett) 对项目的贡献和支持！

## [2025.05.01] - 搜索功能增强
### 新增功能
- 增加搜索书签功能，支持通过书签名称和网址搜索书签

## [2025.04.29] - 界面大改版
### 新增功能
1. 增加分类快捷按钮，书签较多的情况下可一键直达所选分类
2. 大幅更改界面设计
3. 增加 DuckDuckGo 搜索引擎支持

## [2025.01.09] - 导入工具发布
### 新增功能
1. 发布 bookmarks-export-addons（浏览器扩展）
2. 发布 Tampermonkey 脚本
3. 支持将 Chrome 浏览器导出书签转换为 JSON 格式并保存到 KV 存储

## [2024.10.30] - 安全性增强
### 新增功能
1. 增加前端验证机制，取消浏览器日志保存
2. 实现 15分钟登录超时机制，提升隐私安全
3. 新增自动备份功能，KV 存储保存最近10次备份
4. 小幅调整配色方案

## [2024.10.26] - 图标接口修复
### 修复内容
- 更换网站图标获取接口：
  - 主接口：https://www.faviconextractor.com/favicon/
  - 备用接口：https://api.iowen.cn/favicon
- 修复原接口失效问题

## [2024.09.17] - 移动端适配
### 新增功能
- 完成手机端界面适配
- 优化移动设备显示效果

## [2024.09.14] - 功能修复与增强
### 修复内容
1. 修复"删除分类"操作导致的书签显示问题
2. 修复"删除分类"按钮点击后隐藏显示的问题

### 新增功能
- 添加网站图标显示
- 添加操作日志功能

## [2024.09.09] - 核心功能发布
### 新增功能
1. 增加私密书签功能，登录后可见
2. 增加网站分类管理，支持页面内添加和删除分类
3. 增加搜索框功能
4. 集成一言接口

## [2024.09.02] - 首次发布
### 基础功能
- 书签卡片式管理
- 支持自定义网站分类
- 支持暗色主题切换
- 基础的添加、删除、移动书签功能
